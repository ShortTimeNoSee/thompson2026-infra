# /etc/nginx/sites-available/shop.thompson2026.com.conf

server {
    listen 443 ssl;
    listen [::]:443 ssl ipv6only=on;
    server_name shop.thompson2026.com;

    root /var/www/shop.thompson2026.com;
    index index.php;

    # Allow your custom front end (thompson2026.com) to call WooCommerceâ€™s REST API
    location /wp-json/ {
        add_header Access-Control-Allow-Origin https://thompson2026.com;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
        add_header Access-Control-Allow-Headers "Authorization,Content-Type";
        if ($request_method = OPTIONS) {
            return 204;
        }
    }

    # Static assets
    location = /favicon.ico { log_not_found off; access_log off; }
    location = /robots.txt { log_not_found off; access_log off; allow all; }
    location ~* \.(css|gif|ico|jpeg|jpg|js|png)$ {
        expires max;
        log_not_found off;
    }

    # Main front controller
    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    # PHP processing
    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    }

    # Protect hidden files
    location ~ /\.ht {
        deny all;
    }

    # SSL via Certbot
    ssl_certificate /etc/letsencrypt/live/shop.thompson2026.com/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/shop.thompson2026.com/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}

server {
    # Redirect all HTTP to HTTPS
    listen 80;
    listen [::]:80;
    server_name shop.thompson2026.com;

    if ($host = shop.thompson2026.com) {
        return 301 https://$host$request_uri;
    }

    return 404;  # managed by Certbot
}
